/*
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * RadMeter - ESP32 Geiger Counter with Dual Tube Support
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * 
 * ÙŠØ¯Ø¹Ù… Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø£Ù†Ø¨ÙˆØ¨ÙŠ Geiger:
 * - SBM-20 (Ø±ÙˆØ³ÙŠ): Ù…Ø¹Ø§Ù…Ù„ 0.00812 Î¼Sv/h per CPM
 * - J305 (ØµÙŠÙ†ÙŠ):  Ù…Ø¹Ø§Ù…Ù„ 0.00332 Î¼Sv/h per CPM
 * 
 * Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª:
 * âœ“ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨ÙŠÙ† Ø§Ù„Ø£Ù†Ø¨ÙˆØ¨ÙŠÙ†
 * âœ“ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø¯Ø§Ø¦Ù…Ø© (EEPROM)
 * âœ“ WebServer Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªØ­ÙƒÙ…
 * âœ“ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø®Ø§Ø¯Ù… Flask
 * âœ“ Ø­Ø³Ø§Ø¨Ø§Øª Ø¯Ù‚ÙŠÙ‚Ø© Ù„Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„Ù…Ù…ØªØµØ©
 * 
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 */

#include <WiFi.h>
#include <HTTPClient.h>
#include <WebServer.h>
#include <Preferences.h>
#include <ArduinoJson.h>  // ØªØ£ÙƒØ¯ Ù…Ù† ØªØ«Ø¨ÙŠØª Ù…ÙƒØªØ¨Ø© ArduinoJson

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙˆØ§ÙŠ ÙØ§ÙŠ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const char* ssid = "MSR-2";
const char* password = "[REDACTED:password]";  // Ø¶Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø®ÙˆØ§Ø¯Ù…
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const char* serverUrl = "http://192.168.0.190:5000/data";            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
const char* settingsUrl = "http://192.168.0.190:5000/api/get_tube_settings";  // Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const int geigerPin = 25;  // GPIO 25 Ù„Ø¹Ø¯ Ù†Ø¨Ø¶Ø§Øª Geiger
const unsigned long MEASURE_INTERVAL = 60000;  // Ù‚ÙŠØ§Ø³ ÙƒÙ„ 60 Ø«Ø§Ù†ÙŠØ©

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ø£Ù†Ø§Ø¨ÙŠØ¨ (Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù„Ù…ÙŠ)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Ø£Ù†Ø¨ÙˆØ¨ SBM-20 (Ø±ÙˆØ³ÙŠ - Ù…Ø¹Ø§ÙŠØ±Ø© Cs-137)
const float SBM20_FACTOR_EXPOSURE = 0.00926;   // Ø¬Ø±Ø¹Ø© Ø§Ù„ØªØ¹Ø±Ø¶ (Exposure Dose)
const float SBM20_FACTOR_ABSORBED = 0.00812;   // Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„Ù…Ù…ØªØµØ© (Absorbed Dose) â­ Ù…ÙˆØµÙ‰ Ø¨Ù‡

// Ø£Ù†Ø¨ÙˆØ¨ J305 (ØµÙŠÙ†ÙŠ - Ù…Ø¹Ø§ÙŠØ±Ø© Co-60)
const float J305_FACTOR_EXPOSURE = 0.00378;    // Ø¬Ø±Ø¹Ø© Ø§Ù„ØªØ¹Ø±Ø¶ (Exposure Dose)
const float J305_FACTOR_ABSORBED = 0.00332;    // Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„Ù…Ù…ØªØµØ© (Absorbed Dose) â­ Ù…ÙˆØµÙ‰ Ø¨Ù‡

// Ù…Ù„Ø§Ø­Ø¸Ø©: Ù†Ø³ØªØ®Ø¯Ù… Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„Ù…Ù…ØªØµØ© (Absorbed Dose) Ù„Ø£Ù†Ù‡ ÙŠÙ…Ø«Ù„
// Ø§Ù„ØªØ£Ø«ÙŠØ± Ø§Ù„ÙØ¹Ù„ÙŠ Ø¹Ù„Ù‰ Ø¬Ø³Ù… Ø§Ù„Ø¥Ù†Ø³Ø§Ù† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¬Ø³Ù… Ø§Ù„ÙˆÙ‡Ù…ÙŠ (Phantom Model)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
volatile unsigned long counts = 0;           // Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†Ø¨Ø¶Ø§Øª
unsigned long previousMillis = 0;
double totalAbsorbedDose = 0.0;              // Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠØ© (Î¼Sv)

// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù†Ø¨ÙˆØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ
String currentTubeType = "J305";             // Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
float currentFactorExposure = J305_FACTOR_EXPOSURE;
float currentFactorAbsorbed = J305_FACTOR_ABSORBED;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ÙƒØ§Ø¦Ù†Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
WebServer server(80);        // Ø®Ø§Ø¯Ù… ÙˆÙŠØ¨ Ù„Ù„ØªØ­ÙƒÙ…
Preferences preferences;     // Ø°Ø§ÙƒØ±Ø© Ø¯Ø§Ø¦Ù…Ø© Ù„Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ù‚Ø§Ø·Ø¹Ø© Ù„Ø¹Ø¯ Ø§Ù„Ù†Ø¨Ø¶Ø§Øª
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
void IRAM_ATTR countPulse() {
  counts++;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ø£Ù†Ø¨ÙˆØ¨
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
void updateConversionFactors() {
  if (currentTubeType == "SBM20") {
    currentFactorExposure = SBM20_FACTOR_EXPOSURE;
    currentFactorAbsorbed = SBM20_FACTOR_ABSORBED;
    Serial.println("ğŸ“¡ Ù…Ø¹Ø§Ù…Ù„Ø§Øª SBM-20 Ù…ÙÙØ¹Ù‘Ù„Ø©");
  } else if (currentTubeType == "J305") {
    currentFactorExposure = J305_FACTOR_EXPOSURE;
    currentFactorAbsorbed = J305_FACTOR_ABSORBED;
    Serial.println("ğŸ“¡ Ù…Ø¹Ø§Ù…Ù„Ø§Øª J305 Ù…ÙÙØ¹Ù‘Ù„Ø©");
  }
  
  Serial.printf("   - Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„ØªØ¹Ø±Ø¶: %.5f Î¼Sv/h per CPM\n", currentFactorExposure);
  Serial.printf("   - Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„Ø§Ù…ØªØµØ§Øµ: %.5f Î¼Sv/h per CPM\n", currentFactorAbsorbed);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø¯Ø§Ø¦Ù…Ø©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
void loadSettings() {
  preferences.begin("radmeter", false);  // false = read/write mode
  
  // ØªØ­Ù…ÙŠÙ„ Ù†ÙˆØ¹ Ø§Ù„Ø£Ù†Ø¨ÙˆØ¨ (Ø§ÙØªØ±Ø§Ø¶ÙŠ: J305)
  currentTubeType = preferences.getString("tube_type", "J305");
  
  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
  totalAbsorbedDose = preferences.getDouble("total_dose", 0.0);
  
  preferences.end();
  
  Serial.println("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø©:");
  Serial.printf("   - Ù†ÙˆØ¹ Ø§Ù„Ø£Ù†Ø¨ÙˆØ¨: %s\n", currentTubeType.c_str());
  Serial.printf("   - Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠØ©: %.5f Î¼Sv\n", totalAbsorbedDose);
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª
  updateConversionFactors();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø¯Ø§Ø¦Ù…Ø©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
void saveSettings() {
  preferences.begin("radmeter", false);
  preferences.putString("tube_type", currentTubeType);
  preferences.putDouble("total_dose", totalAbsorbedDose);
  preferences.end();
  
  Serial.println("ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API: ØªØºÙŠÙŠØ± Ù†ÙˆØ¹ Ø§Ù„Ø£Ù†Ø¨ÙˆØ¨
// POST /set_tube
// Body: {"tube": "SBM20"} Ø£Ùˆ {"tube": "J305"}
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
void handleSetTube() {
  if (server.hasArg("plain")) {
    String body = server.arg("plain");
    Serial.println("ğŸ“¥ Ø·Ù„Ø¨ ØªØºÙŠÙŠØ± Ø§Ù„Ø£Ù†Ø¨ÙˆØ¨:");
    Serial.println(body);
    
    // ØªØ­Ù„ÙŠÙ„ JSON
    StaticJsonDocument<200> doc;
    DeserializationError error = deserializeJson(doc, body);
    
    if (error) {
      Serial.println("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ JSON");
      server.send(400, "application/json", 
                 "{\"success\":false,\"error\":\"Invalid JSON\"}");
      return;
    }
    
    String newTube = doc["tube"].as<String>();
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù†ÙˆØ¹
    if (newTube == "SBM20" || newTube == "J305") {
      currentTubeType = newTube;
      updateConversionFactors();
      saveSettings();
      
      // Ø¥Ø±Ø³Ø§Ù„ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù†Ø¬Ø§Ø­
      String response = "{\"success\":true,\"tube\":\"" + currentTubeType + 
                       "\",\"factor_absorbed\":" + String(currentFactorAbsorbed, 5) + 
                       ",\"factor_exposure\":" + String(currentFactorExposure, 5) + "}";
      
      server.send(200, "application/json", response);
      
      Serial.println("âœ… ØªÙ… Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ Ø£Ù†Ø¨ÙˆØ¨: " + currentTubeType);
    } else {
      server.send(400, "application/json", 
                 "{\"success\":false,\"error\":\"Invalid tube type. Use SBM20 or J305\"}");
      Serial.println("âŒ Ù†ÙˆØ¹ Ø£Ù†Ø¨ÙˆØ¨ ØºÙŠØ± ØµØ­ÙŠØ­: " + newTube);
    }
  } else {
    server.send(400, "application/json", 
               "{\"success\":false,\"error\":\"No data received\"}");
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API: Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ø£Ù†Ø¨ÙˆØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ
// GET /get_tube
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
void handleGetTube() {
  String response = "{\"success\":true,\"tube\":\"" + currentTubeType + 
                   "\",\"factor_absorbed\":" + String(currentFactorAbsorbed, 5) + 
                   ",\"factor_exposure\":" + String(currentFactorExposure, 5) + 
                   ",\"total_dose\":" + String(totalAbsorbedDose, 5) + "}";
  
  server.send(200, "application/json", response);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API: Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠØ©
// POST /reset_dose
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
void handleResetDose() {
  totalAbsorbedDose = 0.0;
  saveSettings();
  
  server.send(200, "application/json", 
             "{\"success\":true,\"message\":\"Total dose reset to 0\"}");
  
  Serial.println("ğŸ”„ ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠØ©");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API: Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
// GET /status
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
void handleStatus() {
  String response = "{";
  response += "\"success\":true,";
  response += "\"tube\":\"" + currentTubeType + "\",";
  response += "\"wifi_rssi\":" + String(WiFi.RSSI()) + ",";
  response += "\"uptime\":" + String(millis() / 1000) + ",";
  response += "\"total_dose\":" + String(totalAbsorbedDose, 5) + ",";
  response += "\"ip\":\"" + WiFi.localIP().toString() + "\"";
  response += "}";
  
  server.send(200, "application/json", response);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø¬Ù„Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù†ÙˆØ¹ Ø§Ù„Ø£Ù†Ø¨ÙˆØ¨ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…
// ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§ Ø¨Ø¹Ø¯ ÙƒÙ„ Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
void fetchTubeSettings() {
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("âš ï¸  Ø§Ù„ÙˆØ§ÙŠ ÙØ§ÙŠ ØºÙŠØ± Ù…ØªØµÙ„ - Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª");
    return;
  }
  
  HTTPClient http;
  http.begin(settingsUrl);
  http.setTimeout(3000);  // Ø§Ù†ØªØ¸Ø§Ø± 3 Ø«ÙˆØ§Ù†ÙŠ ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰
  
  int httpResponseCode = http.GET();
  
  if (httpResponseCode == 200) {
    String payload = http.getString();
    Serial.println("ğŸ“¥ Ø§Ø³ØªÙ„Ø§Ù… Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…:");
    Serial.println(payload);
    
    // ØªØ­Ù„ÙŠÙ„ JSON
    StaticJsonDocument<300> doc;
    DeserializationError error = deserializeJson(doc, payload);
    
    if (!error) {
      bool success = doc["success"];
      
      if (success) {
        String serverTubeType = doc["tube_type"].as<String>();
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØºÙŠÙŠØ± Ù†ÙˆØ¹ Ø§Ù„Ø£Ù†Ø¨ÙˆØ¨
        if (serverTubeType != currentTubeType) {
          Serial.println("ğŸ”„ ØªØºÙŠÙŠØ± ÙÙŠ Ù†ÙˆØ¹ Ø§Ù„Ø£Ù†Ø¨ÙˆØ¨:");
          Serial.printf("   Ù…Ù†: %s\n", currentTubeType.c_str());
          Serial.printf("   Ø¥Ù„Ù‰: %s\n", serverTubeType.c_str());
          
          // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØºÙŠÙŠØ±
          currentTubeType = serverTubeType;
          updateConversionFactors();
          saveSettings();
          
          Serial.println("âœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØºÙŠÙŠØ± Ø¨Ù†Ø¬Ø§Ø­!");
        } else {
          Serial.println("âœ“ Ù†ÙˆØ¹ Ø§Ù„Ø£Ù†Ø¨ÙˆØ¨ Ù„Ù… ÙŠØªØºÙŠØ±: " + currentTubeType);
        }
      } else {
        Serial.println("âš ï¸  Ø§Ù„Ø®Ø§Ø¯Ù… Ù„Ù… ÙŠØ±Ø¬Ø¹ Ù†Ø¬Ø§Ø­");
      }
    } else {
      Serial.println("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ JSON Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…");
    }
  } else if (httpResponseCode > 0) {
    Serial.printf("âš ï¸  Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹Ø© Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…: %d\n", httpResponseCode);
  } else {
    // Ø§Ù„Ø®Ø§Ø¯Ù… ØºÙŠØ± Ù…ØªØ§Ø­ - Ù„Ø§ Ø¨Ø£Ø³ØŒ Ù†Ø³ØªÙ…Ø± Ø¨Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    // Serial.printf("âš ï¸  Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…: %d\n", httpResponseCode);
  }
  
  http.end();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Setup - Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
void setup() {
  Serial.begin(115200);
  delay(1000);
  
  Serial.println("\n\n");
  Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  Serial.println("   RadMeter - ESP32 Geiger Counter v2.0");
  Serial.println("   Dual Tube Support: SBM-20 & J305");
  Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  
  // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¯Ø®Ù„ Geiger
  pinMode(geigerPin, INPUT);
  attachInterrupt(digitalPinToInterrupt(geigerPin), countPulse, FALLING);
  Serial.println("âœ… ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¯Ø®Ù„ Geiger (GPIO 25)");
  
  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
  loadSettings();
  
  // Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„ÙˆØ§ÙŠ ÙØ§ÙŠ
  Serial.print("\nğŸ“¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„ÙˆØ§ÙŠ ÙØ§ÙŠ");
  WiFi.begin(ssid, password);
  
  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 20) {
    delay(500);
    Serial.print(".");
    attempts++;
  }
  
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\nâœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„ÙˆØ§ÙŠ ÙØ§ÙŠ Ø¨Ù†Ø¬Ø§Ø­!");
    Serial.print("   IP Address: ");
    Serial.println(WiFi.localIP());
    Serial.print("   Signal Strength: ");
    Serial.print(WiFi.RSSI());
    Serial.println(" dBm");
  } else {
    Serial.println("\nâŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„ÙˆØ§ÙŠ ÙØ§ÙŠ!");
    Serial.println("   Ø³ÙŠØªÙ… Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ ÙÙŠ Loop");
  }
  
  // Ø¥Ø¹Ø¯Ø§Ø¯ Ø®Ø§Ø¯Ù… Ø§Ù„ÙˆÙŠØ¨
  server.on("/set_tube", HTTP_POST, handleSetTube);
  server.on("/get_tube", HTTP_GET, handleGetTube);
  server.on("/reset_dose", HTTP_POST, handleResetDose);
  server.on("/status", HTTP_GET, handleStatus);
  
  server.begin();
  Serial.println("âœ… Ø®Ø§Ø¯Ù… Ø§Ù„ÙˆÙŠØ¨ ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ÙØ° 80");
  
  Serial.println("\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  Serial.println("   Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø²!");
  Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
  
  previousMillis = millis();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Loop - Ø§Ù„Ø­Ù„Ù‚Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
void loop() {
  // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ø§Øª Ø®Ø§Ø¯Ù… Ø§Ù„ÙˆÙŠØ¨
  server.handleClient();
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆÙ‚Øª Ø§Ù„Ù‚ÙŠØ§Ø³
  unsigned long currentMillis = millis();
  if (currentMillis - previousMillis >= MEASURE_INTERVAL) {
    previousMillis = currentMillis;
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 1ï¸âƒ£ Ø­Ø³Ø§Ø¨ CPM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    unsigned long cpm = counts;
    counts = 0;  // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ø¯Ø§Ø¯
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 2ï¸âƒ£ Ø­Ø³Ø§Ø¨ Ù…Ø¹Ø¯Ù„Ø§Øª Ø§Ù„Ø¬Ø±Ø¹Ø© (Î¼Sv/h)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    double sourcePower = cpm * currentFactorExposure;      // Ø¬Ø±Ø¹Ø© Ø§Ù„ØªØ¹Ø±Ø¶
    double absorbedDoseRate = cpm * currentFactorAbsorbed; // Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„Ù…Ù…ØªØµØ©
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 3ï¸âƒ£ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠØ©
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¬Ø±Ø¹Ø© Ø¨ÙˆØ­Ø¯Ø© Î¼Sv/hØŒ Ù†Ø­ØªØ§Ø¬ Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø© ÙÙŠ Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØ§Ø­Ø¯Ø©
    // Ø§Ù„Ø¬Ø±Ø¹Ø© ÙÙŠ Ø¯Ù‚ÙŠÙ‚Ø© = (Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¬Ø±Ø¹Ø© Ø¨Ø§Ù„Ø³Ø§Ø¹Ø©) / 60
    double absorbedDosePerMinute = absorbedDoseRate / 60.0;  // Î¼Sv/min
    totalAbsorbedDose += absorbedDosePerMinute;               // Î¼Sv Ø¥Ø¬Ù…Ø§Ù„ÙŠ
    
    // Ø­ÙØ¸ Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠØ© ÙƒÙ„ 10 Ù‚ÙŠØ§Ø³Ø§Øª (ÙƒÙ„ 10 Ø¯Ù‚Ø§Ø¦Ù‚)
    static int saveCounter = 0;
    if (++saveCounter >= 10) {
      saveSettings();
      saveCounter = 0;
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 4ï¸âƒ£ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    Serial.println("\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MEASUREMENT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    Serial.printf("ğŸ”¬ Ø£Ù†Ø¨ÙˆØ¨ Geiger:           %s\n", currentTubeType.c_str());
    Serial.printf("ğŸ“Š CPM:                     %lu\n", cpm);
    Serial.printf("â˜¢ï¸  Ø¬Ø±Ø¹Ø© Ø§Ù„ØªØ¹Ø±Ø¶:           %.5f Î¼Sv/h\n", sourcePower);
    Serial.printf("ğŸ’‰ Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„Ù…Ù…ØªØµØ©:    %.5f Î¼Sv/h\n", absorbedDoseRate);
    Serial.printf("ğŸ“ˆ Ø§Ù„Ø¬Ø±Ø¹Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©:    %.5f Î¼Sv\n", absorbedDosePerMinute);
    Serial.printf("ğŸ“Š Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠØ©:       %.5f Î¼Sv\n", totalAbsorbedDose);
    Serial.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 5ï¸âƒ£ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø®Ø§Ø¯Ù…
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if (WiFi.status() == WL_CONNECTED) {
      HTTPClient http;
      http.begin(serverUrl);
      http.addHeader("Content-Type", "application/json");
      
      // Ø¨Ù†Ø§Ø¡ JSON Ø¨Ù†ÙØ³ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…
      String jsonData = "{";
      jsonData += "\"cpm\":" + String(cpm) + ",";
      jsonData += "\"source_power\":" + String(sourcePower, 5) + ",";
      jsonData += "\"absorbed_dose\":" + String(absorbedDoseRate, 5) + ",";
      jsonData += "\"total_dose\":" + String(totalAbsorbedDose, 5);
      jsonData += "}";
      
      // Ø¥Ø±Ø³Ø§Ù„ POST
      int httpResponseCode = http.POST(jsonData);
      
      if (httpResponseCode > 0) {
        Serial.printf("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø®Ø§Ø¯Ù… - Ø§Ø³ØªØ¬Ø§Ø¨Ø©: %d\n", httpResponseCode);
        String response = http.getString();
        Serial.println("   Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©: " + response);
      } else {
        Serial.printf("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: %d\n", httpResponseCode);
        Serial.println("   Ø§Ù„Ø³Ø¨Ø¨: " + http.errorToString(httpResponseCode));
      }
      
      http.end();
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // 6ï¸âƒ£ Ø¬Ù„Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù†ÙˆØ¹ Ø§Ù„Ø£Ù†Ø¨ÙˆØ¨ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      delay(500);  // Ø§Ù†ØªØ¸Ø§Ø± Ù‚ØµÙŠØ± Ø¨ÙŠÙ† Ø§Ù„Ø·Ù„Ø¨Ø§Øª
      fetchTubeSettings();
      
    } else {
      Serial.println("âš ï¸  Ø§Ù„ÙˆØ§ÙŠ ÙØ§ÙŠ ØºÙŠØ± Ù…ØªØµÙ„ - Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
      // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„
      WiFi.reconnect();
    }
    
    Serial.println();
  }
}

/*
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØªØ«Ø¨ÙŠØª ÙˆØ§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * 
 * 1. Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:
 *    - WiFi (Ù…Ø¯Ù…Ø¬Ø© ÙÙŠ ESP32)
 *    - HTTPClient (Ù…Ø¯Ù…Ø¬Ø© ÙÙŠ ESP32)
 *    - WebServer (Ù…Ø¯Ù…Ø¬Ø© ÙÙŠ ESP32)
 *    - Preferences (Ù…Ø¯Ù…Ø¬Ø© ÙÙŠ ESP32)
 *    - ArduinoJson (ÙŠØ¬Ø¨ ØªØ«Ø¨ÙŠØªÙ‡Ø§ Ù…Ù† Library Manager)
 * 
 * 2. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø§Ø¯Ù…:
 *    - Ø¹Ø¯Ù‘Ù„ serverUrl ÙÙŠ Ø§Ù„Ø³Ø·Ø± 34 (Ø¹Ù†ÙˆØ§Ù† Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
 *    - Ø¹Ø¯Ù‘Ù„ settingsUrl ÙÙŠ Ø§Ù„Ø³Ø·Ø± 35 (Ø¹Ù†ÙˆØ§Ù† Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª)
 *    - ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ†Ø§ Ù†ÙØ³ Ø§Ù„Ø®Ø§Ø¯Ù…ØŒ ÙÙ‚Ø· Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ù…Ø®ØªÙ„ÙØ©
 * 
 * 3. Ø¢Ù„ÙŠØ© Ø§Ù„Ø¹Ù…Ù„:
 *    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 *    â”‚ ÙƒÙ„ 60 Ø«Ø§Ù†ÙŠØ©:                               â”‚
 *    â”‚  1. Ù‚Ø±Ø§Ø¡Ø© CPM ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø©                â”‚
 *    â”‚  2. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ /data (POST)       â”‚
 *    â”‚  3. Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† /api/get_tube_settingsâ”‚
 *    â”‚  4. ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØºÙŠÙŠØ± Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±            â”‚
 *    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 * 
 * 4. API Endpoints Ø§Ù„Ù…Ø­Ù„ÙŠØ© (WebServer Ø¹Ù„Ù‰ ESP32):
 *    POST /set_tube       - ØªØºÙŠÙŠØ± Ù†ÙˆØ¹ Ø§Ù„Ø£Ù†Ø¨ÙˆØ¨ Ù…Ø­Ù„ÙŠØ§Ù‹
 *    GET  /get_tube       - Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ø£Ù†Ø¨ÙˆØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ
 *    POST /reset_dose     - Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠØ©
 *    GET  /status         - Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
 * 
 * 5. Ø£Ù…Ø«Ù„Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… (Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø­Ù„ÙŠ):
 *    curl -X POST http://ESP_IP/set_tube -H "Content-Type: application/json" -d '{"tube":"SBM20"}'
 *    curl http://ESP_IP/get_tube
 *    curl -X POST http://ESP_IP/reset_dose
 *    curl http://ESP_IP/status
 * 
 * 6. Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©:
 *    SBM-20: 0.00812 Î¼Sv/h per CPM (Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„Ù…Ù…ØªØµØ© - Ù…ÙˆØµÙ‰ Ø¨Ù‡)
 *    J305:   0.00332 Î¼Sv/h per CPM (Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„Ù…Ù…ØªØµØ© - Ù…ÙˆØµÙ‰ Ø¨Ù‡)
 * 
 * 7. Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© (Ù…Ø¹Ø§ÙŠÙŠØ± ICRP-103 & IAEA):
 *    Ø³Ø§Ø¹ÙŠØ§Ù‹:  Ø¢Ù…Ù† â‰¤ 0.3 | ØªØ­Ø°ÙŠØ± > 2.38 | Ø®Ø·Ø± â‰¥ 2.38 Î¼Sv/h
 *    ÙŠÙˆÙ…ÙŠØ§Ù‹:  Ø§Ù„Ø­Ø¯ 54.8 Î¼Sv | ØªØ­Ø°ÙŠØ± Ø¹Ù†Ø¯ 80% | Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¹Ù†Ø¯ 50%
 *    Ø³Ù†ÙˆÙŠØ§Ù‹:  Ø§Ù„Ø­Ø¯ 20 mSv (20000 Î¼Sv) | ØªØ­Ø°ÙŠØ± Ø¹Ù†Ø¯ 80%
 * 
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 */
