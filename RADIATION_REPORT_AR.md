# تقرير نظام قياس الإشعاع RadMeter (ESP32 + Flask)

هذا التقرير يوضح آلية حساب الإشعاع على مستوى جهاز ESP32، وكيفية انتقال ومعالجة البيانات داخل النظام الخلفي، وطريقة حساب المعدلات (الساعية) والجرعات التراكمية (اليومية/السنوية) ضمن قاعدة البيانات.


## 1) نظرة عامة على البنية
- العتاد: ESP32 متصل بأنبوب Geiger (يدعم أنبوبين: SBM‑20 وJ305).
- البرمجيات على ESP32: عدّ نبضات الإشعاع عبر مقاطعة IRQ، ثم تجميع القياسات كل 60 ثانية لحساب CPM ومعدلات الجرعة.
- النقل: إرسال JSON بالـ HTTP إلى الخادم على المسار POST /data.
- الخادم (Flask):
  - يستقبل القراءة ويضيفها إلى تخزين مؤقت (in‑memory cache).
  - مهمة خلفية تحفظ القراءات دورياً في SQLite (radiation_readings_local).
  - ربط القراءات بجلسات تعرض الموظفين (employee_exposure_sessions) عند وجود جلسات نشطة.
  - واجهات API لحساب وتجميع الجرعات اليومية/الأسبوعية/الشهرية/السنوية، ومتوسطات معدلات الجرعة، وإرجاع أحدث القراءات للواجهة الأمامية.

الملفات الأساسية:
- ESP32: GGreg20_v3_dual_tube_support.ino
- الخادم: app.py، cache_manager.py، scheduler.py، time_utils.py، database_setup.py
- الواجهة: static/js/radiation.js


## 2) حسابات الإشعاع على ESP32
المصدر: GGreg20_v3_dual_tube_support.ino

1) عدّ النبضات
- يتم إعداد مدخل Geiger على GPIO 25.
- كل نبضة تسجل عبر مقاطعة: counts++.

2) نافذة القياس
- قياس دوري كل 60 ثانية (MEASURE_INTERVAL = 60000 ms).
- عند اكتمال الدقيقة، يتم:
  - حساب CPM = عدد النبضات في آخر دقيقة.
  - تصفير العداد counts لاستخدامه في الدقيقة القادمة.

3) تحويل CPM إلى معدل جرعة (μSv/h)
- يعتمد على نوع الأنبوب:
  - SBM‑20: factor_absorbed = 0.00812 μSv/h لكل CPM
  - J305:   factor_absorbed = 0.00332 μSv/h لكل CPM
- الصيغة:
  - absorbed_dose_rate_μSv_per_h = CPM × factor_absorbed
  - كما يحسب أيضاً source_power (جرعة التعرض) بمعامل مخصص لكل أنبوب.

4) الجرعة التراكمية (Total Dose)
- بما أن absorbed_dose_rate بوحدة μSv/h، فالجرعة خلال دقيقة واحدة:
  - dose_per_minute_μSv = absorbed_dose_rate / 60
- يضيف ESP32 هذه القيمة إلى totalAbsorbedDose كل دقيقة:
  - totalAbsorbedDose += absorbed_dose_rate / 60

5) إدارة نوع الأنبوب والمعاملات
- يحتفظ ESP32 بنوع الأنبوب الحالي في الذاكرة الدائمة (Preferences) ويتيح التحكم عبر خادم ويب محلي:
  - GET /get_tube، POST /set_tube
- بعد إرسال كل قراءة للخادم الرئيسي، يجلب ESP32 الإعداد الموثوق من الخادم عبر GET /api/get_tube_settings ويحدّث المعاملات تلقائياً إذا تغيّر النوع.

6) الإرسال إلى الخادم
- كل دقيقة يُرسل JSON إلى POST /data بالتنسيق:
  {
    "cpm": <int>,
    "source_power": <float μSv/h>,
    "absorbed_dose": <float μSv/h>,
    "total_dose": <float μSv>
  }


## 3) مسار معالجة البيانات على الخادم
المصدر: app.py، cache_manager.py

1) الاستقبال الفوري
- POST /data يتأكد من وجود الحقول الأربعة (cpm, source_power, absorbed_dose, total_dose).
- تُحوّل absorbed_dose إلى absorbed_dose_rate داخلياً.
- تُخزَّن القراءة فوراً في الذاكرة المؤقتة RadiationCache:
  - تحتوي القراءة على: cpm، source_power، absorbed_dose_rate، total_absorbed_dose، timestamp.

2) الحفظ إلى قاعدة البيانات (خلفية)
- خيط خلفي background_database_sync يسحب القراءات غير المحفوظة من الذاكرة المؤقتة كل ~30 ثانية ويحفظها في SQLite (جدول radiation_readings_local).
- إذا وُجدت جلسات تعرض نشطة (is_active=1) في employee_exposure_sessions، تُنسخ القراءة لكل جلسة نشطة مع session_id لربط القراءة بالموظف المعني. وإلا تُحفظ كقراءة عامة بدون session_id.

3) التزويد بالبيانات الحديثة
- GET /api/radiation_data يعيد أحدث قراءة من الذاكرة المؤقتة؛ وإن لم تتوفر، يبحث عن آخر قراءة من SQLite.


## 4) الجلسات وحساب الجرعات الفعلية للموظفين
المصدر: app.py (start_exposure_session, end_exposure_session, calculate_employee_exposure)

- عند تسجيل الحضور (check_in) يبدأ النظام جلسة تعرض يومية للموظف، وعند الانصراف (check_out) تُغلق الجلسة.
- حساب التعرض الفعلي داخل الجلسة يعتمد على قراءات الجرعة اللحظية مع الزمن:
  - تُرتب قراءات absorbed_dose_rate زمنياً ويُحسب التعرض المتزايد لكل فترة Δt بين قراءتين:
    exposure_increment_μSv = absorbed_dose_rate(μSv/h) × Δt(hours)
  - تُجمع كل الزيادات للحصول على إجمالي التعرض للجلسة.
- بدائل/تصحيحات:
  - إذا تعذر الحساب من القراءات، يُستخدم الفرق في total_absorbed_dose (آخر − أول) للجلسة.
  - إذا كان الفرق غير صالح، يُقدّر التعرض = متوسط معدل الجرعة × مدة الجلسة.


## 5) تعريفات المعدلات والجرعات عبر الزمن
يوجد أكثر من تعريف “للمعدل الساعي” بحسب السياق:

A) المعدل اللحظي الذي يرسله ESP32
- المتغير absorbed_dose_rate (μSv/h) يُعاد حسابه كل دقيقة على ESP32 من CPM والمعامل.
- هذا ليس “متوسط ساعة”، بل معدل محين بدقة نافذة دقيقة.

B) المتوسط الساعي من بيانات قاعدة البيانات (آخر ساعة)
- يستخدم النظام متوسطاً حسابياً لقراءات absorbed_dose_rate المسجلة في آخر 60 دقيقة:
  - hourly_avg_rate = AVG(absorbed_dose_rate) WHERE timestamp > now − 1 hour
- هذا يعادل متوسط معدلات الجرعة التي حفظت تقريباً مرة كل دقيقة.

C) متوسط معدل الجرعة لجلسة معينة
- عندما يكون لدينا جلسة بمدة زمنية معروفة وحصيلة تعرض إجمالية:
  - session_avg_rate(μSv/h) = total_exposure(μSv) / duration_hours(h)
- يُستخدم هذا التعريف في التقارير/التجميعات لتقييم كثافة الجرعة خلال فترة عمل محددة.

D) الجرعة اليومية/الأسبوعية/الشهرية/السنوية (تراكم)
- لا تُحسب كـ “متوسطات” بل كـ “مجاميع تعرض” ضمن إطار زمني:
  - daily_dose = مجموع total_exposure لكل الجلسات المغلقة في نفس اليوم + التعرض الجاري للجلسات النشطة اليوم.
  - weekly_dose = مجموع الجلسات في آخر 7 أيام.
  - monthly_dose = مجموع الجلسات في آخر 30 يوماً.
  - annual_dose = مجموع الجلسات في آخر 365 يوماً.
- تُحسب أيضاً نسب مئوية مقابل حدود قياسية:
  - daily_percentage = daily_dose / 54.8 × 100
  - annual_percentage = annual_dose / 20000 × 100

ملاحظات مهمة:
- حين تتوفر session_id، يُعتمد الفرق بين أول وآخر total_absorbed_dose داخل الجلسة لتعقب التعرض الجاري بدقة حتى قبل الإغلاق.
- توجد أيضاً دوال للحصول على إحصاءات الجرعة (MAX/MIN/AVG) داخل مدى زمني محدد من جدول radiation_readings_local.


## 6) حدود الأمان والتصنيف
- الخلفية الطبيعية القصوى: ~0.3 μSv/h (UNSCEAR)
- مستوى التحذير/الخطر (في الواجهة): ≥ 2.38 μSv/h
- حد الجرعة اليومية للعاملين: 54.8 μSv
- حد الجرعة السنوية للعاملين: 20000 μSv (20 mSv)
- التصنيف (آمن/مراقبة/تحذير/خطر) يُبنى على النسب المئوية من الحدود وعلى معدل الجرعة.


## 7) ملخص الصيغ الأساسية
- CPM: عدد النبضات في دقيقة.
- معدل الجرعة اللحظي (μSv/h):
  - absorbed_dose_rate = CPM × factor_absorbed
- جرعة الدقيقة (μSv):
  - dose_per_minute = absorbed_dose_rate / 60
- الجرعة التراكمية على ESP32 (μSv):
  - total_dose += absorbed_dose_rate / 60 كل دقيقة
- متوسط ساعة (من قاعدة البيانات):
  - hourly_avg_rate = متوسط absorbed_dose_rate خلال آخر 60 دقيقة
- متوسط الجلسة (μSv/h):
  - session_avg_rate = total_exposure / duration_hours
- الجرعات التراكمية الزمنية:
  - daily_dose/weekly_dose/monthly_dose/annual_dose = مجموع total_exposure للجلسات ضمن النوافذ الزمنية.


## 8) مخطط سير مبسط
1) ESP32: عدّ → CPM → معدل جرعة → تحديث total_dose → إرسال JSON كل دقيقة.
2) Flask: يستقبل → يضيف للتخزين المؤقت → يحفظ بمهام خلفية إلى SQLite.
3) عند وجود جلسات موظفين نشطة: تُربط القراءات بـ session_id.
4) الاستعلامات: تُستخرج أحدث القراءات، المتوسطات الساعية، ومجاميع الجرعات اليومية/السنوية.


هذا التوثيق يعكس السلوك الفعلي للكود في المستودع الحالي، بما في ذلك معاملات التحويل، طريقة التجميع، وإستراتيجية الحفظ والربط مع جلسات التعرض.
